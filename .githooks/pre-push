#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Alexander Minges
set -euo pipefail

# Pre-push hook to validate that all commits being pushed follow Conventional Commits
# This prevents malformed commits that may have bypassed commit-msg hook during rebases

remote="$1"
url="$2"

# Conventional Commits pattern (type[!][scope]: subject)
regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([^)]+\))?(!)?: .+'

has_errors=0

# Read stdin to get the refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    # Deleting a branch, skip validation
    continue
  fi

  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch, check all commits
    range="$local_sha"
  else
    # Updating existing branch, check new commits only
    range="$remote_sha..$local_sha"
  fi

  # Get all commit messages in the range
  while IFS= read -r commit_msg; do
    # Skip merge commits
    if [[ "$commit_msg" =~ ^Merge ]]; then
      continue
    fi

    # Check if commit message follows Conventional Commits
    if [[ ! "$commit_msg" =~ $regex ]]; then
      echo "ERROR: Invalid commit message format:" >&2
      echo "  '$commit_msg'" >&2
      echo >&2
      echo "Commit messages must follow Conventional Commits specification." >&2
      echo "Example: feat: add new feature" >&2
      echo "         fix(ui): correct button alignment" >&2
      echo >&2
      echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert" >&2
      has_errors=1
    fi
  done < <(git log --format=%s "$range")
done

if [ $has_errors -eq 1 ]; then
  echo >&2
  echo "Push rejected due to invalid commit messages." >&2
  echo "Please fix the commit messages using 'git rebase -i' or 'git commit --amend'." >&2
  exit 1
fi

exit 0
